input_slider:
  alarmhour:
    name: Hour
    icon: mdi:timer
    initial: 6
    min: 0
    max: 23
    step: 1
  alarmminutes:
    name: Minutes
    icon: mdi:timer
    initial: 0
    min: 0
    max: 55
    step: 5

input_boolean:
  activate_alarm:
    name: "Activate Alarm"
    initial: off
    icon: mdi:alarm-check
  alarmweekday:
    name: "Weekdays Only"
    initial: on
    icon: mdi:calendar

sensor:
  - platform: template
    sensors:
      alarm_time:
        friendly_name: 'Alarm Set'
        value_template: '{% if states.input_slider.alarmhour.state|round(0)|string|length == 1 %}0{% endif %}{{ states.input_slider.alarmhour.state|round(0)|string }}:{% if states.input_slider.alarmminutes.state|round(0)|string|length == 1 %}0{% endif %}{{ states.input_slider.alarmminutes.state|round(0)|string }}'
        icon_template: '{% if states.input_boolean.activate_alarm.state == "on" %}mdi:alarm-multiple{% elif states.input_boolean.activate_alarm.state == "off" %}mdi:alarm-off{% else %}mdi:alarm{% endif %}'
        entity_id:
          - input_slider.alarmminutes
          - input_slider.alarmhour

# group:
#   alarmclock:
#     name: Alarm Clock
#     control: hidden
#     entities:
#       - input_boolean.activate_alarm
#       # - automation.set_alarm
#       - sensor.alarm_time
#       - input_slider.alarmhour
#       - input_slider.alarmminutes
#       - input_boolean.alarmweekday

automation:
  - alias: 'Set Alarm'
    initial_state: 'off'
    hide_entity: True
    trigger:
      - platform: time
        minutes: '/5'
        seconds: 2
    condition:
      - condition: template
        value_template: '{{ now().hour == (states.input_slider.alarmhour.state | round(0)) and now().minute == (states.input_slider.alarmminutes.state | round(0) ) }}'
      - condition: or
        conditions:
          - condition: and
            conditions:
              - condition: state
                entity_id: input_boolean.alarmweekday
                state: 'on'
              - condition: time
                weekday:
                  - mon
                  - tue
                  - wed
                  - thu
                  - fri
          - condition: state
            entity_id: input_boolean.alarmweekday
            state: 'off'
    action:
      - service: notify.email
        data:
          title: "It is an alarm time"
          message: 'It is an alarm time [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'
      - service: script.alarm_lighting
      - service: homeassistant.turn_off
        entity_id: automation.set_alarm
      - service: input_boolean.turn_off
        entity_id: input_boolean.activate_alarm
  - alias: "Alarm Enabled"
    initial_state: 'on'
    hide_entity: True
    trigger:
      - platform: state
        entity_id: input_slider.alarmhour, input_slider.alarmminutes
    action:
      - service: homeassistant.turn_off
        entity_id: automation.set_alarm
      - service: input_boolean.turn_off
        entity_id: input_boolean.activate_alarm

script:
  alarm_lighting:
    alias: "Alarm Lighting"
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.alarmstatus
      - service: light.turn_on
        entity_id: light.bedroom_3
        data:
          transition: 180
          brightness: 10
          xy_color: [0.675,0.322]
      - delay: 00:00:10
      - service: light.turn_on
        entity_id: light.bedroom_4
        data:
          transition: 180
          brightness: 10
          xy_color: [0.675,0.322]
      - delay: 00:03:00
      - service: light.turn_on
        entity_id: light.bedroom_1
        data:
          transition: 780
          brightness: 120
          xy_color: [0.5704, 0.3978]
      - service: light.turn_on
        entity_id: light.bedroom_2
        data:
          transition: 780
          brightness: 120
          xy_color: [0.5704, 0.3978]
      - delay: 00:05:00
      - service: light.turn_on
        entity_id: light.bedroom_1
        data:
          transition: 100
          brightness: 255
          xy_color: [0.3138,0.3238]
      - service: light.turn_on
        entity_id: light.bedroom_2
        data:
          transition: 100
          brightness: 255
          xy_color: [0.3138,0.3238]
      - delay: 00:02:00
      - service: light.turn_on
        entity_id: light.bedroom_1
        data:
          flash: long
      - service: light.turn_on
        entity_id: light.bedroom_2
        data:
          flash: long
      - delay: 00:02:00
      - service: light.turn_on
        entity_id: light.bedroom_3
        data:
          effect: colorloop
      - service: light.turn_on
        entity_id: light.bedroom_4
        data:
          effect: colorloop
      - delay: 00:03:00
      - service: light.turn_off
        entity_id: light.bedroom_3
      - service: light.turn_off
        entity_id: light.bedroom_4
      - delay: 00:00:01
      - service: light.turn_on
        entity_id: light.bedroom_1
        data:
          flash: long
      - service: light.turn_on
        entity_id: light.bedroom_2
        data:
          flash: long
      - delay: 00:02:00
      - service: light.turn_off
        entity_id: light.bedroom_1
      - service: light.turn_off
        entity_id: light.bedroom_2
      - service: light.turn_off
        entity_id: light.bedroom_3
      - service: light.turn_off
        entity_id: light.bedroom_4
