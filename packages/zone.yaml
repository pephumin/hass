zone:
  - name: Home
    icon: mdi:home
    latitude: !secret latitude_home
    longitude: !secret longitude_home
    radius: 100
  - name: Benjawan
    icon: mdi:home-variant
    latitude: !secret latitude_benjawan
    longitude: !secret longitude_benjawan
    radius: 100
  - name: Malaiwan
    icon: mdi:home-modern
    latitude: !secret latitude_malaiwan
    longitude: !secret longitude_malaiwan
    radius: 100
  - name: Seacon Square
    icon: mdi:shopping
    latitude: !secret latitude_seaconsquare
    longitude: !secret longitude_seaconsquare
    radius: 100
  - name: Paradise Park
    icon: mdi:shopping
    latitude: !secret latitude_paradisepark
    longitude: !secret longitude_paradisepark
    radius: 100
  - name: Central Bangna
    icon: mdi:shopping
    latitude: !secret latitude_centralbangna
    longitude: !secret longitude_centralbangna
    radius: 100

proximity:
  pe_home:
    zone: home
    devices:
      - device_tracker.pesiphone6
    tolerance: 20
    unit_of_measurement: m
  jue_home:
    zone: home
    devices:
      - device_tracker.juesiphone6splus
    tolerance: 20
    unit_of_measurement: m
  jue_malaiwan:
    zone: malaiwan
    devices:
      - device_tracker.juesiphone6splus
    tolerance: 20
    unit_of_measurement: m
  pe_benjawan:
    zone: benjawan
    devices:
      - device_tracker.pesiphone6
    tolerance: 20
    unit_of_measurement: m

camera:
  - platform: generic
    name: Current Location Pe
    still_image_url: https://maps.googleapis.com/maps/api/staticmap?center={{ states.device_tracker.pesiphone6.attributes.latitude }},{{ states.device_tracker.pesiphone6.attributes.longitude }}&zoom=13&size=500x500&maptype=roadmap&markers=color:red%7Clabel:P%7C{{ states.device_tracker.pesiphone6.attributes.latitude }},{{ states.device_tracker.pesiphone6.attributes.longitude }}
    limit_refetch_to_url_change: true
  - platform: generic
    name: Current Location Jue
    still_image_url: https://maps.googleapis.com/maps/api/staticmap?center={{ states.device_tracker.juesiphone6splus.attributes.latitude }},{{ states.device_tracker.juesiphone6splus.attributes.longitude }}&zoom=13&size=500x500&maptype=roadmap&markers=color:red%7Clabel:P%7C{{ states.device_tracker.juesiphone6splus.attributes.latitude }},{{ states.device_tracker.juesiphone6splus.attributes.longitude }}
    limit_refetch_to_url_change: true

sensor:
  - platform: google_travel_time
    name: "Home to Benjy"
    api_key: !secret google_travel_time_api_key
    origin: zone.home
    destination: zone.benjawan
    options:
      mode: driving
      units: metric
  - platform: google_travel_time
    name: "Benjy to Home"
    api_key: !secret google_travel_time_api_key
    origin: zone.benjawan
    destination: zone.home
    options:
      mode: driving
      units: metric
  - platform: google_travel_time
    name: "Home to Malaiwan"
    api_key: !secret google_travel_time_api_key
    origin: zone.home
    destination: zone.malaiwan
    options:
      mode: driving
      units: metric
  - platform: google_travel_time
    name: "Malaiwan to Home"
    api_key: !secret google_travel_time_api_key
    origin: zone.malaiwan
    destination: zone.home
    options:
      mode: driving
      units: metric

input_boolean:
  presence_pe:
    name: "Pe at Home"
    initial: on
    icon: mdi:duck
  presence_jue:
    name: "Jue at Home"
    initial: on
    icon: mdi:owl
  presence_benjy:
    name: "Benjy Visits"
    initial: off
    icon: mdi:robot
  presence_pe_benjawan:
    name: "Pe at Benjawan"
    initial: off
    icon: mdi:cat
  presence_jue_malaiwan:
    name: "Jue at Malaiwan"
    initial: off
    icon: mdi:flower

binary_sensor:
  - platform: ping
    host: 192.168.1.124
    name: "pesiphone6"
  - platform: ping
    host: 192.168.1.181
    name: "pesipadmini2"
  - platform: ping
    host: 192.168.1.110
    name: "juesiphone6splus"
  - platform: ping
    host: 192.168.1.129
    name: "juesipadmini2"
  - platform: ping
    host: 192.168.1.180
    name: "pesipodtouch4"
  - platform: ping
    host: 192.168.1.202
    name: "benjy"
  # - platform: trend
  #   sensors:
  #     pe_going_home:
  #       friendly_name: 'Pe Going Home'
  #       entity_id: proximity.pe_home
  #       device_class: moving
  # - platform: trend
  #   sensors:
  #     jue_going_home:
  #       friendly_name: 'Jue Going Home'
  #       entity_id: proximity.jue_home
  #       device_class: moving
  # - platform: trend
  #   sensors:
  #     pe_going_benjawan:
  #       friendly_name: 'Pe Going Benjawans'
  #       entity_id: proximity.pe_benjawan
  #       device_class: moving
  # - platform: trend
  #   sensors:
  #     jue_going_malaiwan:
  #       friendly_name: 'Jue Going Malaiwan'
  #       entity_id: proximity.jue_malaiwan
  #       device_class: moving

automation:

  - alias: "Pe is at Luzern"
    hide_entity: True
    trigger:
      - platform: template
        value_template: '{{ (is_state("device_tracker.pesiphone6", "home") or is_state("device_tracker.user_pesiphone6", "home")) }}'
      - platform: numeric_state
        entity_id: proximity.pe_home
        below: 10
      - platform: zone
        entity_id: device_tracker.pesiphone6
        zone: zone.home
        event: enter
    condition:
      - condition: template
        value_template: '{{ (is_state("input_boolean.presence_pe", "off") and (is_state("device_tracker.ping_pesiphone6", "home") or is_state("binary_sensor.pesiphone6", "on"))) }}'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.presence_pe

  - alias: "Pe is not at Luzern"
    hide_entity: True
    trigger:
      - platform: template
        value_template: '{{ (is_state("device_tracker.pesiphone6", "not_home") or is_state("device_tracker.user_pesiphone6", "not_home")) }}'
      - platform: numeric_state
        entity_id: proximity.pe_home
        above: 1000
      - platform: zone
        entity_id: device_tracker.pesiphone6
        zone: zone.home
        event: leave
    condition:
      - condition: template
        value_template: '{{ (is_state("input_boolean.presence_pe", "on") and (is_state("device_tracker.ping_pesiphone6", "not_home") or is_state("binary_sensor.pesiphone6", "off"))) }}'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.presence_pe

  - alias: "Pe Arrives Home"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: input_boolean.presence_pe
        from: 'off'
        to: 'on'
        for:
          minutes: 2
    condition:
      - condition: template
        value_template: '{{ is_state("input_boolean.presence_jue", "off") }}'
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "chime"
          light: "once"
          mobile: "jue"
          title: "Pe has arrived home"
          message: 'Pe has arrived home [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Pe Leaves Home"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: input_boolean.presence_pe
        from: 'on'
        to: 'off'
        for:
          minutes: 2
    condition:
      - condition: template
        value_template: '{{ is_state("input_boolean.presence_jue", "off") }}'
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "chime"
          light: "once"
          mobile: "jue"
          title: "Pe has left home"
          message: 'Pe has left home [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Jue is at Luzern"
    hide_entity: True
    trigger:
      - platform: template
        value_template: '{{ (is_state("device_tracker.juesiphone6splus", "home") or is_state("device_tracker.user_juesiphone6splus", "home")) }}'
      - platform: numeric_state
        entity_id: proximity.jue_home
        below: 10
      - platform: zone
        entity_id: device_tracker.juesiphone6splus
        zone: zone.home
        event: enter
    condition:
      - condition: template
        value_template: '{{ (is_state("input_boolean.presence_jue", "off") and (is_state("device_tracker.ping_juesiphone6splus", "home") or is_state("binary_sensor.juesiphone6splus", "on"))) }}'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.presence_jue

  - alias: "Jue is not at Luzern"
    hide_entity: True
    trigger:
      - platform: template
        value_template: '{{ (is_state("device_tracker.juesiphone6splus", "not_home") or is_state("device_tracker.user_juesiphone6splus", "not_home")) }}'
      - platform: numeric_state
        entity_id: proximity.jue_home
        above: 1000
      - platform: zone
        entity_id: device_tracker.juesiphone6splus
        zone: zone.home
        event: leave
    condition:
      - condition: template
        value_template: '{{ (is_state("input_boolean.presence_jue", "on") and (is_state("device_tracker.ping_juesiphone6splus", "not_home") or is_state("binary_sensor.juesiphone6splus", "off"))) }}'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.presence_jue

  - alias: "Jue Arrives Home"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: input_boolean.presence_jue
        from: 'off'
        to: 'on'
        for:
          minutes: 2
    condition:
      - condition: template
        value_template: '{{ is_state("input_boolean.presence_pe", "off") }}'
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "chime"
          light: "once"
          mobile: "pe"
          title: "Jue has arrived home"
          message: 'Jue has arrived home [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Jue Leaves Home"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: input_boolean.presence_jue
        from: 'on'
        to: 'off'
        for:
          minutes: 2
    condition:
      - condition: template
        value_template: '{{ is_state("input_boolean.presence_pe", "off") }}'
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "chime"
          light: "once"
          mobile: "pe"
          title: "Jue has left home"
          message: 'Jue has left home [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Jue is at Malaiwan"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: device_tracker.juesiphone6splus
        from: 'not_home'
        to: 'Malaiwan'
      - platform: template
        value_template: '{{ (is_state("device_tracker.juesiphone6splus", "Malaiwan") or is_state("device_tracker.user_juesiphone6splus", "Malaiwan")) }}'
      - platform: numeric_state
        entity_id: proximity.jue_malaiwan
        below: 10
      - platform: zone
        entity_id: device_tracker.juesiphone6splus
        zone: zone.malaiwan
        event: enter
    condition:
      - condition: template
        value_template: '{{ is_state("input_boolean.presence_jue_malaiwan", "off") }}'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.presence_jue_malaiwan

  - alias: "Jue is not at Malaiwan"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: device_tracker.juesiphone6splus
        from: 'Malaiwan'
        to: 'not_home'
      - platform: template
        value_template: '{{ (is_state("device_tracker.juesiphone6splus", "not_home") or is_state("device_tracker.user_juesiphone6splus", "not_home")) }}'
      - platform: numeric_state
        entity_id: proximity.jue_malaiwan
        above: 1000
      - platform: zone
        entity_id: device_tracker.juesiphone6splus
        zone: zone.malaiwan
        event: leave
    condition:
      - condition: template
        value_template: '{{ is_state("input_boolean.presence_jue_malaiwan", "on") }}'
      # - condition: template
      #   value_template: "{{ trigger.from_state.state == 'Malaiwan' }}"
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.presence_jue_malaiwan

  - alias: "Jue Arrives Malaiwan"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: input_boolean.presence_jue_malaiwan
        from: 'off'
        to: 'on'
        for:
          minutes: 2
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "pip"
          light: "short"
          mobile: "pe"
          title: "Jue has arrived Malaiwan"
          message: 'Jue has arrived Malaiwan [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Jue Leaves Malaiwan"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: input_boolean.presence_jue_malaiwan
        from: 'on'
        to: 'off'
        for:
          minutes: 2
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "pip"
          light: "short"
          mobile: "pe"
          title: "Jue has left Malaiwan"
          message: 'Jue has left Malaiwan [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Pe is at Benjawan"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: device_tracker.pesiphone6
        from: 'not_home'
        to: 'Benjawan'
      - platform: template
        value_template: '{{ (is_state("device_tracker.pesiphone6", "Benjawan") or is_state("device_tracker.user_pesiphone6", "Benjawan")) }}'
      - platform: numeric_state
        entity_id: proximity.pe_benjawan
        below: 10
      - platform: zone
        entity_id: device_tracker.pesiphone6
        zone: zone.benjawan
        event: enter
    condition:
      - condition: template
        value_template: '{{ is_state("input_boolean.presence_pe_benjawan", "off") }}'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.presence_pe_benjawan

  - alias: "Pe is not at Benjawan"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: device_tracker.pesiphone6
        from: 'Benjawan'
        to: 'not_home'
      - platform: template
        value_template: '{{ (is_state("device_tracker.pesiphone6", "not_home") or is_state("device_tracker.user_pesiphone6", "not_home")) }}'
      - platform: numeric_state
        entity_id: proximity.pe_benjawan
        above: 1000
      - platform: zone
        entity_id: device_tracker.pesiphone6
        zone: zone.benjawan
        event: leave
    condition:
      - condition: template
        value_template: '{{ is_state("input_boolean.presence_pe_benjawan", "on") }}'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.presence_pe_benjawan

  - alias: "Pe Arrives Benjawan"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: input_boolean.presence_pe_benjawan
        from: 'off'
        to: 'on'
        for:
          minutes: 2
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "pip"
          light: "short"
          mobile: "jue"
          title: "Pe has arrived Benjawan"
          message: 'Pe has arrived Benjawan [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Pe Leaves Benjawan"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: input_boolean.presence_pe_benjawan
        from: 'on'
        to: 'off'
        for:
          minutes: 2
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "pip"
          light: "short"
          mobile: "jue"
          title: "Pe has left Benjawan"
          message: 'Pe has left Benjawan [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Jue 3km away from Luzern"
    hide_entity: True
    trigger:
      - platform: numeric_state
        entity_id: proximity.jue_home
        below: 3200
        above: 2800
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "chime"
          light: "once"
          mobile: "pe"
          title: "Jue is 3km away from Home"
          message: 'Jue is 3km away from Home [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Jue 2km away from Luzern"
    hide_entity: True
    trigger:
      - platform: numeric_state
        entity_id: proximity.jue_home
        below: 2200
        above: 1800
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "chime"
          light: "once"
          mobile: "pe"
          title: "Jue is 2km away from Home"
          message: 'Jue is 2km away from Home [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Jue 1km away from Luzern"
    hide_entity: True
    trigger:
      - platform: numeric_state
        entity_id: proximity.jue_home
        below: 1200
        above: 800
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "chime"
          light: "once"
          mobile: "pe"
          title: "Jue is 1km away from Home"
          message: 'Jue is 1km away from Home [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Pe 3km away from Luzern"
    hide_entity: True
    trigger:
      - platform: numeric_state
        entity_id: proximity.pe_home
        below: 3200
        above: 2800
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "chime"
          light: "once"
          mobile: "jue"
          title: "Pe is 3km away from Home"
          message: 'Pe is 3km away from Home [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Pe 2km away from Luzern"
    hide_entity: True
    trigger:
      - platform: numeric_state
        entity_id: proximity.pe_home
        below: 2200
        above: 1800
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "chime"
          light: "once"
          mobile: "jue"
          title: "Pe is 2km away from Home"
          message: 'Pe is 2km away from Home [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Pe 1km away from Luzern"
    hide_entity: True
    trigger:
      - platform: numeric_state
        entity_id: proximity.pe_home
        below: 1200
        above: 800
    action:
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "chime"
          light: "once"
          mobile: "jue"
          title: "Pe is 1km away from Home"
          message: 'Pe is 1km away from Home [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Benjy is at Luzern"
    hide_entity: True
    trigger:
      - platform: template
        value_template: '{{ is_state("device_tracker.benjy", "home") }}'
      - platform: zone
        entity_id: device_tracker.benjy
        zone: zone.home
        event: enter
    condition:
      - condition: template
        value_template: '{{ (is_state("input_boolean.presence_benjy", "off") and (is_state("device_tracker.ping_benjy", "home") or is_state("binary_sensor.benjy", "on"))) }}'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.presence_benjy

  - alias: "Benjy is not at Luzern"
    hide_entity: True
    trigger:
      - platform: template
        value_template: '{{ is_state("device_tracker.benjy", "not_home") }}'
      - platform: zone
        entity_id: device_tracker.benjy
        zone: zone.home
        event: leave
    condition:
      - condition: template
        value_template: '{{ (is_state("input_boolean.presence_benjy", "on") and (is_state("device_tracker.ping_benjy", "not_home") or is_state("binary_sensor.benjy", "off"))) }}'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.presence_benjy

  - alias: "Benjy Arrives Home"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: input_boolean.presence_benjy
        from: 'off'
        to: 'on'
        for:
          minutes: 2
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.homemode
          option: Visitor
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "siren"
          light: "long"
          mobile: "both"
          title: "Benjy visits and she has arrived"
          message: 'Benjy visits and she has arrived [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'

  - alias: "Benjy Leaves Home"
    hide_entity: True
    trigger:
      - platform: state
        entity_id: input_boolean.presence_benjy
        from: 'on'
        to: 'off'
        for:
          minutes: 2
    action:
      - service: input_select.select_previous
        data:
          entity_id: input_select.homemode
      - service: script.notifying
        data:
          email: "false"
          tv: "true"
          speak: "true"
          audio: "siren"
          light: "long"
          mobile: "both"
          title: "Benjy has left"
          message: 'Benjy has left [{{now().strftime("%d.%m.%y")}} {{now().strftime("%H:%M")}}]'
